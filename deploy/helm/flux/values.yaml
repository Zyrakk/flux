# ============================================================================
# Flux ‚Äî Configuration Values
# ============================================================================

# -- Global settings
global:
  imageRegistry: ""
  imagePullPolicy: Never
  security:
    allowInsecureImages: true

# ============================================================================
# API Server
# ============================================================================
api:
  replicaCount: 1
  image:
    repository: flux-api
    tag: "latest"
  port: 8080
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  # -- Node selector (useful for hybrid clusters like Pi + x86)
  nodeSelector: {}

# ============================================================================
# Frontend (SvelteKit node adapter)
# ============================================================================
frontend:
  enabled: true
  replicaCount: 1
  image:
    repository: flux-frontend
    tag: "latest"
  port: 3000
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  nodeSelector: {}

# ============================================================================
# Workers (CronJobs)
# ============================================================================
workerRss:
  enabled: true
  schedule: "*/30 * * * *"
  image:
    repository: flux-worker-rss
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 128Mi
  nodeSelector: {}

workerHn:
  enabled: true
  schedule: "*/15 * * * *"
  minScore: 10
  image:
    repository: flux-worker-hn
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 128Mi
  nodeSelector: {}

# ============================================================================
# Processor (daemon)
# ============================================================================
processor:
  enabled: true
  replicaCount: 1
  image:
    repository: flux-processor
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  nodeSelector: {}

# ============================================================================
# Embeddings Service (FastAPI + all-MiniLM-L6-v2)
# ============================================================================
embeddingsSvc:
  enabled: true
  replicaCount: 1
  image:
    repository: flux-embeddings-svc
    tag: "latest"
  port: 8000
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # N150 (x86) por defecto; para Oracle ARM cambia a arm64.
  nodeSelector:
    kubernetes.io/arch: amd64

# ============================================================================
# Briefing Generator (CronJob)
# ============================================================================
briefingGen:
  enabled: true
  schedule: "0 3 * * *"
  image:
    repository: flux-briefing-gen
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  nodeSelector: {}

# ============================================================================
# LLM Configuration (Critical ‚Äî choose your provider)
# ============================================================================
llm:
  # -- Provider: "glm" | "openai_compat" | "anthropic"
  provider: "glm"
  # -- API endpoint URL
  endpoint: "https://open.bigmodel.cn/api/coding/paas/v4"
  # -- Model name
  model: "glm-4.7"
  # -- API key (reference to a secret)
  apiKeySecretRef:
    name: flux-llm-secret
    key: api-key

# ============================================================================
# Sections (briefing categories)
# ============================================================================
sections:
  cybersecurity:
    enabled: true
    displayName: "üîí Cybersecurity"
    maxBriefingArticles: 5
  tech:
    enabled: true
    displayName: "üíª Tech"
    maxBriefingArticles: 5
  economy:
    enabled: true
    displayName: "üìà Economy"
    maxBriefingArticles: 3
  world:
    enabled: true
    displayName: "üåç World"
    maxBriefingArticles: 2

# ============================================================================
# Rate Limiting
# ============================================================================
rateLimit:
  # -- Rate limits per domain. Format: "requests/period" (sec, min, hour)
  limits:
    reddit.com: "60/min"
    hacker-news.firebaseio.com: "30/min"
    api.github.com: "83/min"
    default: "10/min"
  userAgent: "Flux/1.0 (+https://github.com/zyrak/flux)"

# ============================================================================
# Relevance
# ============================================================================
relevance:
  thresholdDefault: "0.30"
  thresholdMin: "0.15"
  thresholdMax: "0.60"
  thresholdStep: "0.05"
  sourceBoosts: "tl;dr sec=0.1"

# ============================================================================
# Auth & section profile recalc
# ============================================================================
auth:
  token: ""

profileRecalc:
  trigger: "immediate"
  every: "1h"

# ============================================================================
# Ingress (Traefik IngressRoute)
# ============================================================================
ingress:
  enabled: true
  host: "flux.zyrak.cloud"
  tls:
    enabled: true
    # -- Name of an existing TLS secret, or use cert-manager
    secretName: "flux-tls"
    certManager:
      enabled: true
      issuerRef:
        name: "letsencrypt-prod"
        kind: "ClusterIssuer"
  annotations: {}

# ============================================================================
# PostgreSQL (Bitnami subchart)
# ============================================================================
postgresql:
  enabled: true
  image:
    repository: bitnamilegacy/postgresql
  auth:
    username: postgres
    password: "flux"
    postgresPassword: "flux"
    database: flux
  primary:
    persistence:
      enabled: false
      size: 10Gi
    initdb:
      scripts:
        01-grant-superuser.sql: |
          ALTER ROLE flux WITH SUPERUSER;

# -- OR use an external database:
# postgresql:
#   enabled: false
# externalDatabase:
#   host: "my-postgres.example.com"
#   port: 5432
#   user: "flux"
#   password: ""
#   database: "flux"
#   existingSecret: ""

# ============================================================================
# NATS (official chart)
# ============================================================================
nats:
  enabled: true
  config:
    jetstream:
      enabled: true
      memStorage:
        size: 256Mi
      fileStorage:
        size: 1Gi

# ============================================================================
# Redis / Valkey (Bitnami subchart)
# ============================================================================
redis:
  enabled: true
  image:
    repository: bitnamilegacy/redis
  architecture: standalone
  auth:
    enabled: false  # Internal network only
  master:
    persistence:
      enabled: false
      size: 1Gi

# ============================================================================
# Migration Job
# ============================================================================
migration:
  # -- Runs as a Helm hook on install/upgrade
  enabled: false
  image:
    repository: flux-api
    tag: "latest"
  # -- Force migration job to a specific node when using local-only images.
  nodeSelector: {}
