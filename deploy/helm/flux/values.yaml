# ============================================================================
# Flux ‚Äî Configuration Values
# ============================================================================

# -- Global settings
global:
  # Keep empty to avoid overriding dependency chart images (PostgreSQL/Redis/NATS).
  imageRegistry: ""
  imagePullPolicy: IfNotPresent
  # Optional pull secrets for private registries.
  imagePullSecrets: []
  security:
    allowInsecureImages: true

# ============================================================================
# API Server
# ============================================================================
api:
  replicaCount: 1
  image:
    repository: ghcr.io/zyrakk/flux-api
    tag: "latest"
  port: 8080
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  # -- Node selector (useful for hybrid clusters like Pi + x86)
  nodeSelector: {}

# ============================================================================
# Frontend (SvelteKit node adapter)
# ============================================================================
frontend:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/zyrakk/flux-frontend
    tag: "latest"
  port: 3000
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  nodeSelector: {}

# ============================================================================
# Workers (CronJobs)
# ============================================================================
workerRss:
  enabled: true
  schedule: "*/30 * * * *"
  image:
    repository: ghcr.io/zyrakk/flux-worker-rss
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 128Mi
  nodeSelector: {}

workerHn:
  enabled: true
  schedule: "*/15 * * * *"
  minScore: 10
  image:
    repository: ghcr.io/zyrakk/flux-worker-hn
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 128Mi
  nodeSelector: {}

workerReddit:
  enabled: true
  schedule: "*/30 * * * *"
  image:
    repository: ghcr.io/zyrakk/flux-worker-reddit
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 128Mi
  nodeSelector: {}

workerGithub:
  enabled: true
  schedule: "0 * * * *"
  image:
    repository: ghcr.io/zyrakk/flux-worker-github
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 128Mi
  nodeSelector: {}

# ============================================================================
# Processor (daemon)
# ============================================================================
processor:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/zyrakk/flux-processor
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  nodeSelector: {}

# ============================================================================
# Embeddings Service (FastAPI + all-MiniLM-L6-v2)
# ============================================================================
embeddingsSvc:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/zyrakk/flux-embeddings-svc
    tag: "latest"
  port: 8000
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # N150 (x86) por defecto; para Oracle ARM cambia a arm64.
  nodeSelector:
    kubernetes.io/arch: amd64

# ============================================================================
# Briefing Generator (CronJob)
# ============================================================================
briefingGen:
  enabled: true
  schedule: "0 3 * * *"
  # IANA timezone. Ensures schedule runs at local 03:00 instead of controller timezone.
  timeZone: "Europe/Madrid"
  image:
    repository: ghcr.io/zyrakk/flux-briefing-gen
    tag: "latest"
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  nodeSelector: {}

# ============================================================================
# LLM Configuration (Critical ‚Äî choose your provider)
# ============================================================================
llm:
  # -- Provider: "glm" | "openai_compat" | "anthropic"
  provider: "glm"
  # -- API endpoint URL
  endpoint: "https://open.bigmodel.cn/api/coding/paas/v4"
  # -- Model name
  model: "glm-4.7"
  # -- API key (reference to a secret)
  apiKeySecretRef:
    name: flux-llm-secret
    key: api-key

# ============================================================================
# Sections (briefing categories)
# ============================================================================
sections:
  cybersecurity:
    enabled: true
    displayName: "üîí Cybersecurity"
    maxBriefingArticles: 5
  tech:
    enabled: true
    displayName: "üíª Tech"
    maxBriefingArticles: 5
  economy:
    enabled: true
    displayName: "üìà Economy"
    maxBriefingArticles: 3
  world:
    enabled: true
    displayName: "üåç World"
    maxBriefingArticles: 2

# ============================================================================
# Rate Limiting
# ============================================================================
rateLimit:
  # -- Rate limits per domain. Format: "requests/period" (sec, min, hour)
  limits:
    reddit.com: "60/min"
    oauth.reddit.com: "60/min"
    hacker-news.firebaseio.com: "30/min"
    api.github.com: "5000/hour"
    default: "10/min"
  userAgent: "Flux/1.0 (+https://github.com/zyrak/flux)"

# ============================================================================
# Relevance
# ============================================================================
relevance:
  thresholdDefault: "0.30"
  thresholdMin: "0.15"
  thresholdMax: "0.60"
  thresholdStep: "0.05"
  sourceBoosts: "tl;dr sec=0.1"

# ============================================================================
# Auth & section profile recalc
# ============================================================================
auth:
  token: ""

secrets:
  # When true (default), chart creates a Secret from values below.
  # For production, prefer existingSecret + leave credential values empty.
  create: true
  # Name of a pre-created Secret with keys:
  # AUTH_TOKEN, LLM_API_KEY, REDDIT_CLIENT_ID, REDDIT_CLIENT_SECRET,
  # REDDIT_USERNAME, REDDIT_PASSWORD, GITHUB_TOKEN
  existingSecret: ""

reddit:
  clientId: ""
  clientSecret: ""
  username: ""
  password: ""

github:
  token: ""

profileRecalc:
  trigger: "immediate"
  every: "1h"

# ============================================================================
# Ingress (Traefik IngressRoute)
# ============================================================================
ingress:
  enabled: true
  host: "flux.zyrak.cloud"
  tls:
    enabled: true
    # -- Name of an existing TLS secret, or use cert-manager
    secretName: "flux-tls"
    certManager:
      enabled: true
      issuerRef:
        name: "letsencrypt-prod"
        kind: "ClusterIssuer"
  annotations: {}

# ============================================================================
# PostgreSQL (Bitnami subchart)
# ============================================================================
postgresql:
  enabled: true
  image:
    repository: bitnamilegacy/postgresql
  auth:
    username: postgres
    # Override in values.local.yaml (gitignored) or use postgresql.auth.existingSecret.
    password: "change-me"
    postgresPassword: "change-me"
    database: flux
  primary:
    persistence:
      enabled: false
      size: 10Gi
    initdb:
      scripts:
        01-grant-superuser.sql: |
          ALTER ROLE flux WITH SUPERUSER;

# -- OR use an external database:
# postgresql:
#   enabled: false
# externalDatabase:
#   host: "my-postgres.example.com"
#   port: 5432
#   user: "flux"
#   password: ""
#   database: "flux"
#   existingSecret: ""

# ============================================================================
# NATS (official chart)
# ============================================================================
nats:
  enabled: true
  config:
    jetstream:
      enabled: true
      memStorage:
        size: 256Mi
      fileStorage:
        size: 1Gi

# ============================================================================
# Redis / Valkey (Bitnami subchart)
# ============================================================================
redis:
  enabled: true
  image:
    repository: bitnamilegacy/redis
  architecture: standalone
  auth:
    enabled: false  # Internal network only
  master:
    persistence:
      enabled: false
      size: 1Gi

# ============================================================================
# Migration Job
# ============================================================================
migration:
  # -- Runs as a Helm hook on install/upgrade
  enabled: false
  image:
    repository: ghcr.io/zyrakk/flux-api
    tag: "latest"
  # -- Force migration job to a specific node when using local-only images.
  nodeSelector: {}
